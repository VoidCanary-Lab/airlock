# Copyright (c) 2025 VoidCanary-Lab
# SPDX-License-Identifier: GPL-3.0-or-later

name: End-to-End Topology Test

on:
  push:
    paths: ['gateware/**', 'infrastructure/**']
  pull_request:

jobs:
  topology-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y iproute2 bridge-utils net-tools

      - name: Install Python Dependencies
        run: sudo python3 -m pip install -r requirements.txt

      - name: Setup Virtual Topology (The "Air Gap")
        run: |
          # 1. Create a Network Namespace for the Vault (Isolated)
          sudo ip netns add vault_ns
          
          # 2. Create Virtual Cables (veth pairs)
          # Link A: External World <-> FPGA Input
          sudo ip link add veth_in type veth peer name veth_in_peer
          # Link B: FPGA Output <-> Vault
          sudo ip link add veth_out type veth peer name veth_out_peer

          # 3. Move one end of Link B into the Vault Namespace
          sudo ip link set veth_out_peer netns vault_ns
          
          # 4. Bring up interfaces
          sudo ip link set veth_in up
          sudo ip link set veth_in_peer up
          sudo ip link set veth_out up
          
          # Inside the Vault, bring up the interface and assign IP
          sudo ip netns exec vault_ns ip link set veth_out_peer up
          sudo ip netns exec vault_ns ip addr add 192.168.100.2/24 dev veth_out_peer

      - name: Start the Gateware Bridge (Background)
        run: |
          # This script reads from veth_in_peer, filters via Amaranth, writes to veth_out
          sudo python3 gateware/sim/bridge.py --rx veth_in_peer --tx veth_out &
          echo "BRIDGE_PID=$!" >> $GITHUB_ENV

      - name: Run Attack Simulation
        run: |
          # 1. Start a listener inside the Vault (to see what gets through)
          sudo ip netns exec vault_ns python3 -u infrastructure/tests/listener.py > capture.log &
          
          # 2. Send BAD traffic (Should be dropped)
          sudo python3 infrastructure/tests/attacker.py --interface veth_in --type MALICIOUS
          
          # 3. Send GOOD traffic (Should pass)
          sudo python3 infrastructure/tests/attacker.py --interface veth_in --type VALID

      - name: Verify Results
        run: |
          if grep -q "MALICIOUS" capture.log; then
            echo "FAILURE: The Airlock leaked a malicious packet!"
            exit 1
          fi
          if grep -q "VALID" capture.log; then
            echo "SUCCESS: The Airlock passed valid traffic."
            exit 0
          else
            echo "FAILURE: The Airlock blocked valid traffic (False Positive)."
            exit 1
          fi